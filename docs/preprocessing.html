---

title: Preprocessing data


keywords: fastai
sidebar: home_sidebar

summary: "Inspecting any particular irregularities and general preparation of the data for modelling as well as basic model inspection."
description: "Inspecting any particular irregularities and general preparation of the data for modelling as well as basic model inspection."
nb_path: "nbs/02_preprocessing.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02_preprocessing.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;plotly&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;../data&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">csvs</span> <span class="o">=</span> <span class="n">inspection</span><span class="o">.</span><span class="n">get_csvs</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
<span class="n">csvs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loading-csvs">Loading csvs<a class="anchor-link" href="#Loading-csvs"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">inspection</span><span class="o">.</span><span class="n">get_core_Xy</span><span class="p">(</span><span class="n">csvs</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span> <span class="n">train</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">inspection</span><span class="o">.</span><span class="n">get_core_Xy</span><span class="p">(</span><span class="n">csvs</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span> <span class="n">test</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">building</span> <span class="o">=</span> <span class="n">inspection</span><span class="o">.</span><span class="n">get_building_X</span><span class="p">(</span><span class="n">csvs</span><span class="p">[</span><span class="s1">&#39;building&#39;</span><span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">building</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span> <span class="n">building</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">weather_train</span> <span class="o">=</span> <span class="n">inspection</span><span class="o">.</span><span class="n">get_weather_X</span><span class="p">(</span><span class="n">csvs</span><span class="p">[</span><span class="s1">&#39;weather_train&#39;</span><span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">weather_train</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span> <span class="n">weather_train</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">weather_test</span> <span class="o">=</span> <span class="n">inspection</span><span class="o">.</span><span class="n">get_weather_X</span><span class="p">(</span><span class="n">csvs</span><span class="p">[</span><span class="s1">&#39;weather_test&#39;</span><span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">weather_test</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span> <span class="n">weather_test</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Wrangling">Wrangling<a class="anchor-link" href="#Wrangling"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Processor" class="doc_header"><code>class</code> <code>Processor</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L29" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Processor</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">process_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">add_time_features</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">add_dep_var_stats</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">df_building</span> <span class="o">=</span> <span class="n">building</span><span class="p">,</span>
    <span class="n">df_weather</span> <span class="o">=</span> <span class="n">weather_train</span>
<span class="p">)</span>
<span class="n">process</span> <span class="o">=</span> <span class="n">Processor</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df</span><span class="p">,</span> <span class="n">var_names</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> 
                        <span class="o">**</span><span class="n">process_config</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df_test</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> 
                     <span class="o">**</span><span class="n">process_config</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">var_names</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="test_var_names" class="doc_header"><code>test_var_names</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L158" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>test_var_names</code>(<strong><code>var_names</code></strong>:<code>dict</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_var_names</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="store_var_names" class="doc_header"><code>store_var_names</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L166" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>store_var_names</code>(<strong><code>data_path</code></strong>:<code>Path</code>, <strong><code>var_names</code></strong>:<code>dict</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">store_var_names</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_var_names" class="doc_header"><code>load_var_names</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L173" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_var_names</code>(<strong><code>fname</code></strong>:<code>Path</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># var_names = load_var_names(data_path/&#39;var_names.pckl&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="store_df" class="doc_header"><code>store_df</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L180" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>store_df</code>(<strong><code>path</code></strong>:<code>Path</code>, <strong><code>df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">store_df</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;X.parquet&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">store_df</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;X_test.parquet&#39;</span><span class="p">,</span> <span class="n">df_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_df" class="doc_header"><code>load_df</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L183" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_df</code>(<strong><code>path</code></strong>:<code>Path</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># df = load_df(data_path/&#39;X.parquet&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Testing-if-certain-features-improve-the-score-beyond-the-baseline">Testing if certain features improve the score beyond the baseline<a class="anchor-link" href="#Testing-if-certain-features-improve-the-score-beyond-the-baseline"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Training to get a basic idea if the added features do have any benefit</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">load_df</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;X.parquet&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">load_df</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;X_test.parquet&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">var_names</span> <span class="o">=</span> <span class="n">load_var_names</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;var_names.pckl&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_tabular_object" class="doc_header"><code>get_tabular_object</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L186" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_tabular_object</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>var_names</code></strong>:<code>dict</code>, <strong><code>splits</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="train_predict" class="doc_header"><code>train_predict</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L196" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>train_predict</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>var_names</code></strong>:<code>dict</code>, <strong><code>model</code></strong>, <strong><code>params</code></strong>:<code>dict</code>=<em><code>None</code></em>, <strong><code>n_rep</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>n_samples_train</code></strong>:<code>int</code>=<em><code>10000</code></em>, <strong><code>n_samples_test</code></strong>:<code>int</code>=<em><code>10000</code></em>, <strong><code>test_size</code></strong>:<code>float</code>=<em><code>0.2</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span>
          <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">RandomForestRegressor</span>
<span class="c1"># params = None</span>
<span class="c1"># model = linear_model.LinearRegression</span>
<span class="n">n_rep</span> <span class="o">=</span> <span class="mi">21</span>
<span class="n">n_samples_train</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">n_samples_test</span> <span class="o">=</span> <span class="mi">1000</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">clu</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df_rep</span> <span class="o">=</span> <span class="n">train_predict</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">var_names</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> 
                       <span class="n">n_rep</span><span class="o">=</span><span class="n">n_rep</span><span class="p">,</span> <span class="n">n_samples_train</span><span class="o">=</span><span class="n">n_samples_train</span><span class="p">,</span>
                       <span class="n">n_samples_test</span><span class="o">=</span><span class="n">n_samples_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_rep</span><span class="p">[</span><span class="s1">&#39;rmse loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">px</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="n">df_rep</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;rmse loss&#39;</span><span class="p">,</span> <span class="n">range_y</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Baseline model = RandomForest with 20 estimators and sqrt features, training over 100k samples and predicting over 1k</p>
<table>
    <tr>
        <th>input</th>
        <th>rmse loss</th>
        <th>time [s/it]</th>
    </tr>
    <tr>
        <td>meter and building id only</td>
        <td>1.2 - 1.21</td>
        <td>10.2</td>
    </tr>
    <tr>
        <td>using dep_var stats</td>
        <td>1.16 - 1.18</td>
        <td>17.3</td>
    </tr>
    <tr>
        <td>using time stats</td>
        <td>1.2 - 1.21</td>
        <td>13.2 - 13.7</td>
    </tr>
    <tr>
        <td>using building info</td>
        <td>1.19</td>
        <td>17 - 18</td>
    </tr>
    <tr>
        <td>using weather (+ building) info</td>
        <td>1.13 - 1.139</td>
        <td>14.6 - 15</td>
    </tr>
    <tr>
        <td>using all above</td>
        <td>1.19 - 1.21</td>
        <td>20 - 26</td>
    </tr>
</table>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Comparing-dep_var-distributions">Comparing <code>dep_var</code> distributions<a class="anchor-link" href="#Comparing-dep_var-distributions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">to</span> <span class="o">=</span> <span class="n">get_tabular_object</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_size</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span>
<span class="n">n_samples_train</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">n_samples_test</span> <span class="o">=</span> <span class="mi">10000</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">test_size</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">xs</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">RandomForestRegressor</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">_X</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n_samples_train</span><span class="p">]</span>
<span class="n">_y</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;dep_var&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n_samples_train</span><span class="p">]</span>
<span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">_y</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">_X</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n_samples_test</span><span class="p">]</span>
<span class="n">_y</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;dep_var&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n_samples_test</span><span class="p">]</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="hist_plot_preds" class="doc_header"><code>hist_plot_preds</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L229" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>hist_plot_preds</code>(<strong><code>y0</code></strong>:<code>ndarray</code>, <strong><code>y1</code></strong>:<code>ndarray</code>, <strong><code>label0</code></strong>:<code>str</code>=<em><code>'y0'</code></em>, <strong><code>label1</code></strong>:<code>str</code>=<em><code>'y1'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hist_plot_preds</span><span class="p">(</span><span class="n">_y</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">label0</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inspecting-confidently-wrong-predictions">Inspecting confidently wrong predictions<a class="anchor-link" href="#Inspecting-confidently-wrong-predictions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BoldlyWrongTimeseries" class="doc_header"><code>class</code> <code>BoldlyWrongTimeseries</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L249" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BoldlyWrongTimeseries</code>(<strong><code>xs</code></strong>, <strong><code>y_true</code></strong>, <strong><code>y_pred</code></strong>, <strong><code>t</code></strong>:<code>DataFrame</code>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">_X</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span> <span class="c1">#.iloc[:n_samples_test]</span>
<span class="n">_y</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;dep_var&#39;</span><span class="p">]]</span> <span class="c1">#.iloc[:n_samples_test]</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">bwt</span> <span class="o">=</span> <span class="n">BoldlyWrongTimeseries</span><span class="p">(</span><span class="n">_X</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span>
                            <span class="n">t</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,[</span><span class="s1">&#39;timestampElapsed&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Adding plotting capability based on the loss or meter/building id</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="plot_boldly_wrong" class="doc_header"><code>plot_boldly_wrong</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L267" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>plot_boldly_wrong</code>(<strong><code>nth_last</code></strong>:<code>int</code>=<em><code>None</code></em>, <strong><code>meter</code></strong>:<code>int</code>=<em><code>None</code></em>, <strong><code>bid</code></strong>:<code>int</code>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bwt</span><span class="o">.</span><span class="n">plot_boldly_wrong</span><span class="p">(</span><span class="n">nth_last</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bwt</span><span class="o">.</span><span class="n">plot_boldly_wrong</span><span class="p">(</span><span class="n">meter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bid</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Adding widgets for interactive exploration</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BoldlyWrongTimeseries.init_widgets" class="doc_header"><code>BoldlyWrongTimeseries.init_widgets</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L296" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BoldlyWrongTimeseries.init_widgets</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BoldlyWrongTimeseries.run_boldly" class="doc_header"><code>BoldlyWrongTimeseries.run_boldly</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L309" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BoldlyWrongTimeseries.run_boldly</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="BoldlyWrongTimeseries.click_boldly_wrong" class="doc_header"><code>BoldlyWrongTimeseries.click_boldly_wrong</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/preprocessing.py#L317" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>BoldlyWrongTimeseries.click_boldly_wrong</code>(<strong><code>change</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bwt</span><span class="o">.</span><span class="n">run_boldly</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

