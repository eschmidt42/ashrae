---

title: Modelling & submitting


keywords: fastai
sidebar: home_sidebar

summary: "Playing with different models and submitting predictions over the test set to kaggle. "
description: "Playing with different models and submitting predictions over the test set to kaggle. "
nb_path: "nbs/all_meters_one_model.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/all_meters_one_model.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Current implementation of this notebook leads to (private leaderboard score):</p>
<ul>
<li>baseline (linear regression on dep_var_stats and meter 1hot) 1.7</li>
<li>RandomForest, tabular_learner, lgbm at ~1.45, </li>
<li>ensembling tabular_learner, RandomForest and lgbm gives ~1.4</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;plotly&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">do_test</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">do_submit</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">loading</span><span class="o">.</span><span class="n">DATA_PATH</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">loading</span><span class="o">.</span><span class="n">N_TRAIN</span> <span class="o">=</span> <span class="mi">100_000</span>
<span class="n">loading</span><span class="o">.</span><span class="n">N_TEST</span> <span class="o">=</span> <span class="mi">100_000</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Loading from scratch</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">ashrae_data</span> <span class="o">=</span> <span class="n">loading</span><span class="o">.</span><span class="n">load_all</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Takes about 3min30</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">processor</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">Processor</span><span class="p">()</span> <span class="c1"># t_train=t_train</span>
<span class="n">tfms_config</span> <span class="o">=</span> <span class="p">{</span>
<span class="c1">#     &#39;fix_bid_363&#39;:{},</span>
<span class="c1">#     &#39;fix_bid_1099&#39;:{&#39;threshold&#39;: 10.},</span>
<span class="c1">#     &#39;remove_bad_meter0_readings_of_first_141days&#39;: {},</span>
<span class="c1">#     &#39;remove_not_summer_0s_meter_2_and_3&#39;: {},</span>
<span class="c1">#     &#39;remove_0s_meter0&#39;: {},</span>
<span class="c1">#     &#39;remove_outliers&#39;:{&#39;f&#39;:10,&#39;dep_var&#39;:&#39;meter_reading&#39;},</span>
<span class="c1">#     &#39;remove_imputed_weeks&#39;:{&#39;dep_var&#39;:&#39;meter_reading&#39;},</span>
<span class="c1">#     &#39;add_dep_var_stats&#39;:{},</span>
    <span class="s1">&#39;add_random_noise_features&#39;</span><span class="p">:{},</span>
    <span class="s1">&#39;add_time_features&#39;</span><span class="p">:{},</span>
    <span class="s1">&#39;add_weather_features&#39;</span><span class="p">:{</span><span class="s1">&#39;fix_time_offset&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;add_na_indicators&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;impute_nas&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
    <span class="s1">&#39;add_building_features&#39;</span><span class="p">:{},</span>
<span class="c1">#     &#39;add_onehot_encoded&#39;:{},</span>
<span class="p">}</span>

<span class="n">df</span><span class="p">,</span> <span class="n">var_names</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">ashrae_data</span><span class="p">[</span><span class="s1">&#39;meter_train&#39;</span><span class="p">],</span> <span class="n">tfms_configs</span><span class="o">=</span><span class="n">tfms_config</span><span class="p">,</span>
                          <span class="n">df_weather</span><span class="o">=</span><span class="n">ashrae_data</span><span class="p">[</span><span class="s1">&#39;weather_train&#39;</span><span class="p">],</span>
                          <span class="n">df_building</span><span class="o">=</span><span class="n">ashrae_data</span><span class="p">[</span><span class="s1">&#39;building&#39;</span><span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span> <span class="n">var_names</span><span class="p">)</span>

<span class="o">%</span><span class="n">time</span>
<span class="n">df_test</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">processor</span><span class="p">(</span><span class="n">ashrae_data</span><span class="p">[</span><span class="s1">&#39;meter_test&#39;</span><span class="p">],</span> <span class="n">tfms_configs</span><span class="o">=</span><span class="n">tfms_config</span><span class="p">,</span>
                         <span class="n">df_weather</span><span class="o">=</span><span class="n">ashrae_data</span><span class="p">[</span><span class="s1">&#39;weather_test&#39;</span><span class="p">],</span>
                         <span class="n">df_building</span><span class="o">=</span><span class="n">ashrae_data</span><span class="p">[</span><span class="s1">&#39;building&#39;</span><span class="p">])</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">align_test</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var_names</span><span class="p">,</span> <span class="n">df_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># df.to_parquet(data_path/&#39;X.parquet&#39;)</span>
<span class="c1"># df_test.to_parquet(data_path/&#39;X_test.parquet&#39;)</span>
<span class="c1"># pickle.dump(var_names, open(data_path/&#39;var_names.pkl&#39;, &#39;wb&#39;))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="evaluate_torch" class="doc_header"><code>evaluate_torch</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/modelling.py#L27" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>evaluate_torch</code>(<strong><code>y_true</code></strong>:<code>Tensor</code>, <strong><code>y_pred</code></strong>:<code>Tensor</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loading">Loading<a class="anchor-link" href="#Loading"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># var_names = preprocessing.load_var_names(data_path/&#39;var_names.pckl&#39;)</span>
<span class="c1"># var_names</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># df = preprocessing.load_df(data_path/&#39;X.parquet&#39;) #.sample(100000)</span>

<span class="c1"># if do_test:</span>
<span class="c1">#     df_test = preprocessing.load_df(data_path/&#39;X_test.parquet&#39;) #.sample(100000)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Sampling-df">Sampling <code>df</code><a class="anchor-link" href="#Sampling-df"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># per building_id and meter sampling</span>
    <span class="n">n_sample_per_bid</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;building_id&#39;</span><span class="p">,</span> <span class="s1">&#39;meter&#39;</span><span class="p">])</span>
         <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_sample_per_bid</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">))</span>

<span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># general sampling</span>
    <span class="n">frac_samples</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span>
    <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="n">frac_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s1"> samples = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> %&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Split">Split<a class="anchor-link" href="#Split"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Split settings</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># t_train = pd.read_parquet(data_path/&#39;t_train.parquet&#39;)</span>
<span class="n">t_train</span> <span class="o">=</span> <span class="kc">None</span>

<span class="o">%</span><span class="n">time</span>
<span class="c1">#split_kind = &#39;random&#39;</span>
<span class="c1">#split_kind = &#39;time&#39;</span>
<span class="c1"># split_kind = &#39;fix_time&#39;</span>
<span class="n">split_kind</span> <span class="o">=</span> <span class="s1">&#39;time_split_day&#39;</span>
<span class="n">train_frac</span> <span class="o">=</span> <span class="o">.</span><span class="mi">9</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Splitting</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">split_dataset</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">split_kind</span><span class="o">=</span><span class="n">split_kind</span><span class="p">,</span> <span class="n">train_frac</span><span class="o">=</span><span class="n">train_frac</span><span class="p">,</span>
                                     <span class="n">t_train</span><span class="o">=</span><span class="n">t_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sets </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span><span class="si">}</span><span class="s1">, train </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, valid </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">var_names</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">var_names_no_anns</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;dep_var&#39;</span><span class="p">:</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;dep_var&#39;</span><span class="p">],</span>
    <span class="s1">&#39;conts&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;conts&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;meter_reading&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">],</span>
    <span class="s1">&#39;cats&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;cats&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;meter_&#39;</span><span class="p">)]</span>
<span class="p">}</span>
<span class="n">var_names_no_anns</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">var_names_anns</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;dep_var&#39;</span><span class="p">:</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;dep_var&#39;</span><span class="p">],</span>
    <span class="s1">&#39;conts&#39;</span><span class="p">:</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;conts&#39;</span><span class="p">],</span>
    <span class="s1">&#39;cats&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;cats&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;meter_&#39;</span><span class="p">)]</span>
<span class="p">}</span>
<span class="n">var_names_anns</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Takes about 6 minutes on 100% of the data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">]</span>
<span class="n">to</span> <span class="o">=</span> <span class="n">feature_testing</span><span class="o">.</span><span class="n">get_tabular_object</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                                        <span class="n">var_names</span><span class="p">,</span>
                                        <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
                                        <span class="n">procs</span><span class="o">=</span><span class="n">procs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Storing <code>to</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># pickle.dump(to, open(data_path/&#39;to.pkl&#39;, &#39;wb&#39;))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Loading <code>to</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># to = pickle.load(open(data_path/&#39;to.pkl&#39;, &#39;rb&#39;))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Creating data loaders</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">train_bs</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">val_bs</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">dls</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="n">train_bs</span><span class="p">,</span> <span class="n">val_bs</span><span class="o">=</span><span class="n">val_bs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Saving dls</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># torch.save(dls, data_path/&#39;dls.pkl&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Warning: Takes about 14min with the test set</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">test_bs</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">test_dl</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">test_bs</span><span class="p">)</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># torch.save(test_dl, data_path/&#39;test_dl.pkl&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Loading dls</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># dls = torch.load(data_path/&#39;dls.pkl&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># test_dl = torch.load(data_path/&#39;test_dl.pkl&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Modelling-with">Modelling with<a class="anchor-link" href="#Modelling-with"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fastai"><code>fastai</code><a class="anchor-link" href="#fastai"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Fastai finding: make sure your test set values are not out of domain $\Rightarrow$ <code>timestampYear</code> in this notebook is put into the training set but there only takes on the value 2016.0, but in the test set it's 2017.0 and 2018.0, causing the predictions to zero out everywhere.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">()]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y_range</span> <span class="o">=</span> <span class="p">(</span><span class="o">-.</span><span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>

<span class="c1"># layers = [4000, 2000, 1000, 500, 250]</span>
<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span> <span class="c1"># [1600, 800, 400, 200]</span>

<span class="c1"># embed_p = .01</span>
<span class="n">embed_p</span> <span class="o">=</span> <span class="mf">0.</span>

<span class="c1"># ps = [.1, .1, .1, .1, .1]</span>
<span class="n">ps</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">]</span>
<span class="c1"># ps[0] = .2</span>

<span class="c1"># config = None</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">tabular_config</span><span class="p">(</span><span class="n">embed_p</span><span class="o">=</span><span class="n">embed_p</span><span class="p">,</span> <span class="n">ps</span><span class="o">=</span><span class="n">ps</span><span class="p">,</span>
<span class="c1">#                         act_cls=Swish(inplace=True)</span>
                        <span class="p">)</span>
<span class="c1"># config = tabular_config(act_cls=nn.ReLU(inplace=True))</span>
<span class="c1"># config = tabular_config(act_cls=Swish(inplace=True))</span>
<span class="c1"># config = tabular_config(act_cls=Sine(inplace=True))</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span> 
                        <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> 
<span class="c1">#                         wd=.01,</span>
                        <span class="n">loss_func</span><span class="o">=</span><span class="n">evaluate_torch</span><span class="p">)</span> <span class="c1">#.to_fp16()</span>
<span class="n">run</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># a counter for `fit_one_cycle` executions</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># learn.save(&#39;1600-800-400-200&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># learn = learn.load(&#39;1600-800-400-200&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">run</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;run #</span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">y_valid_pred</span><span class="p">,</span> <span class="n">y_valid_true</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">()</span>
<span class="n">y_valid_pred_fast</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nb_score</span> <span class="o">=</span> <span class="n">evaluate_torch</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">,</span> 
                          <span class="n">y_valid_pred</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fastai loss </span><span class="si">{</span><span class="n">nb_score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="n">test_dl</span><span class="p">)</span>
    <span class="n">y_test_pred_fast</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">(</span><span class="n">y_test_pred</span><span class="p">)</span>
    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">(</span><span class="n">y_test_pred</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y_valid_pred</span><span class="p">,</span> <span class="n">y_valid_true</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">),</span> <span class="n">cnr</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>replacing categorical features for trees with learned embeddings</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trees_with_embeddings</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">trees_with_embeddings</span><span class="p">:</span>
    <span class="n">X_emb_train</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_emb_val</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="EmbeddingFeatures" class="doc_header"><code>class</code> <code>EmbeddingFeatures</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/modelling.py#L32" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>EmbeddingFeatures</code>(<strong><code>to</code></strong>:<code>TabularPandas</code>, <strong><code>learn</code></strong>:<code>Learner</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">ef</span> <span class="o">=</span> <span class="n">EmbeddingFeatures</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">learn</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ef</span><span class="o">.</span><span class="n">df_embs</span><span class="p">[</span><span class="s1">&#39;building_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">,:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="EmbeddingFeatures.replace_cat_features_with_embeddings" class="doc_header"><code>EmbeddingFeatures.replace_cat_features_with_embeddings</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/modelling.py#L45" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>EmbeddingFeatures.replace_cat_features_with_embeddings</code>(<strong><code>X</code></strong>:<code>DataFrame</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>TODO: fix memory error in the creation of <code>X_emb</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">trees_with_embeddings</span><span class="p">:</span>
    <span class="n">X_emb_train</span> <span class="o">=</span> <span class="n">ef</span><span class="o">.</span><span class="n">replace_cat_features_with_embeddings</span><span class="p">(</span><span class="n">X_emb_train</span><span class="p">)</span>
    <span class="n">X_emb_val</span> <span class="o">=</span> <span class="n">ef</span><span class="o">.</span><span class="n">replace_cat_features_with_embeddings</span><span class="p">(</span><span class="n">X_emb_val</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="sklearn"><code>sklearn</code><a class="anchor-link" href="#sklearn"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">RandomForestRegressor</span>
<span class="c1"># params = {}</span>
<span class="c1"># model = linear_model.LinearRegression</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">trees_with_embeddings</span><span class="p">:</span>
    <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_emb_train</span><span class="p">,</span> <span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="EmbeddingFeatures.embedding_assignment_func" class="doc_header"><code>EmbeddingFeatures.embedding_assignment_func</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/modelling.py#L52" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>EmbeddingFeatures.embedding_assignment_func</code>(<strong><code>stuff</code></strong>:<code>tuple</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="EmbeddingFeatures.predict_with_embeddings" class="doc_header"><code>EmbeddingFeatures.predict_with_embeddings</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/modelling.py#L59" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>EmbeddingFeatures.predict_with_embeddings</code>(<strong><code>X</code></strong>:<code>DataFrame</code>, <strong><code>m</code></strong>, <strong><code>num_rows</code></strong>:<code>int</code>=<em><code>2000000</code></em>, <strong><code>num_workers</code></strong>:<code>int</code>=<em><code>1</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">trees_with_embeddings</span><span class="p">:</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_emb_val</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">y_valid_pred_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include note.html content='the prediction with embeddings takes ~ 37 minutes.' %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">trees_with_embeddings</span><span class="p">:</span>
        <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">ef</span><span class="o">.</span><span class="n">predict_with_embeddings</span><span class="p">(</span><span class="n">test_dl</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> 
                                                 <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dl</span><span class="o">.</span><span class="n">xs</span><span class="p">)</span>
    <span class="n">y_test_pred_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">y_test_pred</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y_valid_true</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">nb_score</span> <span class="o">=</span> <span class="n">evaluate_torch</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">),</span> 
                          <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sklearn loss </span><span class="si">{</span><span class="n">nb_score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="lightgbm"><code>lightgbm</code><a class="anchor-link" href="#lightgbm"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">trees_with_embeddings</span><span class="p">:</span>
    <span class="n">lgb_train</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_emb_train</span><span class="p">,</span> <span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">lgb_eval</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_emb_val</span><span class="p">,</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> 
                           <span class="n">reference</span><span class="o">=</span><span class="n">lgb_train</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">lgb_train</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">lgb_eval</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> 
                           <span class="n">reference</span><span class="o">=</span><span class="n">lgb_train</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;boosting_type&#39;</span><span class="p">:</span> <span class="s1">&#39;gbdt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;regression&#39;</span><span class="p">,</span>
    <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s1">&#39;bagging_freq&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">gbm</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lgb_train</span><span class="p">,</span>
                <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">valid_sets</span><span class="o">=</span><span class="n">lgb_eval</span><span class="p">,</span>
                <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">trees_with_embeddings</span><span class="p">:</span>
    <span class="n">y_valid_pred_lgbm</span> <span class="o">=</span> <span class="n">gbm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_emb_val</span><span class="p">,</span>
                                    <span class="n">num_iteration</span><span class="o">=</span><span class="n">gbm</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_valid_pred_lgbm</span> <span class="o">=</span> <span class="n">gbm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                    <span class="n">num_iteration</span><span class="o">=</span><span class="n">gbm</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">)</span>

<span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">y_valid_pred_lgbm</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">trees_with_embeddings</span><span class="p">:</span>
        <span class="n">y_test_pred_lgbm</span> <span class="o">=</span> <span class="n">gbm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_emb_test</span><span class="p">,</span>
                                       <span class="n">num_iteration</span><span class="o">=</span><span class="n">gbm</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_test_pred_lgbm</span> <span class="o">=</span> <span class="n">gbm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dl</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                       <span class="n">num_iteration</span><span class="o">=</span><span class="n">gbm</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">)</span>
    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">y_test_pred_lgbm</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y_valid_true</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">nb_score</span> <span class="o">=</span> <span class="n">evaluate_torch</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">),</span> 
                          <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;lgbm loss </span><span class="si">{</span><span class="n">nb_score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Ensembling">Ensembling<a class="anchor-link" href="#Ensembling"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span>
    <span class="n">y_valid_pred_sk</span><span class="p">,</span> 
    <span class="n">y_valid_pred_fast</span><span class="p">,</span>
    <span class="n">y_valid_pred_lgbm</span>
<span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">y_valid_true</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">nb_score</span> <span class="o">=</span> <span class="n">evaluate_torch</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">),</span> 
                          <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ensembling loss </span><span class="si">{</span><span class="n">nb_score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span>
        <span class="n">y_test_pred_sk</span><span class="p">,</span> 
        <span class="n">y_test_pred_fast</span><span class="p">,</span> 
        <span class="n">y_test_pred_lgbm</span>
    <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inspecting">Inspecting<a class="anchor-link" href="#Inspecting"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="dep_var-distribution"><code>dep_var</code> distribution<a class="anchor-link" href="#dep_var-distribution"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Train vs validation distributions</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pick_random" class="doc_header"><code>pick_random</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/modelling.py#L82" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pick_random</code>(<strong><code>x</code></strong>, <strong><code>s</code></strong>:<code>int</code>=<em><code>50</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">feature_testing</span><span class="o">.</span><span class="n">hist_plot_preds</span><span class="p">(</span><span class="n">pick_random</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">),</span> 
                                <span class="n">pick_random</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">),</span> 
                                <span class="n">label0</span><span class="o">=</span><span class="s1">&#39;truth&#39;</span><span class="p">,</span> <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">feature_testing</span><span class="o">.</span><span class="n">hist_plot_preds</span><span class="p">(</span><span class="n">pick_random</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">),</span> 
                                    <span class="n">pick_random</span><span class="p">(</span><span class="n">y_test_pred</span><span class="p">),</span> 
                                    <span class="n">label0</span><span class="o">=</span><span class="s1">&#39;truth (validation)&#39;</span><span class="p">,</span> 
                                    <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;prediction (test set)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Boldly-wrong-predictions">Boldly wrong predictions<a class="anchor-link" href="#Boldly-wrong-predictions"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">miss_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;building_id&#39;</span><span class="p">,</span> <span class="s1">&#39;meter&#39;</span><span class="p">,</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">miss_cols</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miss_cols</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span>
<span class="n">bwt</span> <span class="o">=</span> <span class="n">feature_testing</span><span class="o">.</span><span class="n">BoldlyWrongTimeseries</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">y_valid_true</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bwt</span><span class="o">.</span><span class="n">run_boldly</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Submission-to-kaggle">Submission to kaggle<a class="anchor-link" href="#Submission-to-kaggle"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">y_test_pred_original</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="n">y_test_pred</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">y_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cnr</span><span class="p">(</span><span class="n">y_test_pred_original</span><span class="p">),</span>
                         <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;meter_reading&#39;</span><span class="p">],</span>
                         <span class="n">index</span><span class="o">=</span><span class="n">test_dl</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">y_out</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">41697600</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include note.html content='Writing to csv takes ~2min' %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_submit</span><span class="p">:</span>
    <span class="n">y_out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;my_submission.csv&#39;</span><span class="p">,</span>
                 <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>kaggle competitions submit -c ashrae-energy-prediction -f submission.csv -m "Message"</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pretty_dictionary" class="doc_header"><code>pretty_dictionary</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/modelling.py#L85" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pretty_dictionary</code>(<strong><code>d</code></strong>:<code>dict</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">act</span> <span class="o">=</span> <span class="s1">&#39;ReLu&#39;</span>

<span class="c1"># lin_model_msg = f&#39;baseline (linear regression)&#39;</span>
<span class="n">rf_model_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;RandomForest: </span><span class="si">{</span><span class="n">pretty_dictionary</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="k">if</span> <span class="n">trees_with_embeddings</span><span class="p">:</span>
    <span class="n">rf_model_msg</span> <span class="o">+=</span> <span class="s1">&#39; (with embeddings)&#39;</span>
<span class="n">lgbm_model_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;LGBM: </span><span class="si">{</span><span class="n">pretty_dictionary</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

<span class="n">fast_model_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;tabular_learner (run #</span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s1">): act </span><span class="si">{</span><span class="n">act</span><span class="si">}</span><span class="s1">, layers </span><span class="si">{</span><span class="n">layers</span><span class="si">}</span><span class="s1">, ps </span><span class="si">{</span><span class="n">ps</span><span class="si">}</span><span class="s1">, embed_p </span><span class="si">{</span><span class="n">embed_p</span><span class="si">}</span><span class="s1">&#39;</span>

<span class="c1"># model_msg = f&#39;Ensembling tabular_learner and RandomForest ({fast_model_msg}, {rf_model_msg})&#39;</span>
<span class="n">model_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Ensembling LGBM, tabular_learner and RandomForest (</span><span class="si">{</span><span class="n">lgbm_model_msg</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">fast_model_msg</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">rf_model_msg</span><span class="si">}</span><span class="s1">)&#39;</span>
<span class="c1"># model_msg = rf_model_msg</span>
<span class="c1"># model_msg = lgbm_model_msg</span>

<span class="n">split_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;split kind &quot;</span><span class="si">{</span><span class="n">split_kind</span><span class="si">}</span><span class="s1">&quot; N_TRAIN </span><span class="si">{</span><span class="n">loading</span><span class="o">.</span><span class="n">N_TRAIN</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">samples_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;num samples </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">xs</span><span class="p">)</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">xs</span><span class="p">)</span><span class="o">/</span><span class="mi">20216100</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> %&#39;</span>
<span class="n">features_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;weather and building features&#39;</span>
<span class="n">score_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;nb score </span><span class="si">{</span><span class="n">nb_score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="c1"># message = [&#39;baseline (linear regression on dep_var_stats and 1hot meter) &#39;, &#39;500 obs/bid&#39;, f&#39;nb score {nb_score:.4f}&#39;]</span>
<span class="c1"># message = [&#39;random forest&#39;, &#39;500 obs/bid&#39;, &#39;all features&#39;, f&#39;nb score {nb_score:.4f}&#39;]</span>
<span class="c1"># message = [&#39;lightgbm&#39;, &#39;500 obs/bid&#39;, &#39;100 rounds&#39;, &#39;42 leaves&#39;, &#39;lr .5&#39;, f&#39;nb score {nb_score:.4f}&#39;]</span>
<span class="c1"># message = [&#39;tabular_learner&#39;, &#39;500 obs/bid&#39;, &#39;all features&#39;, f&#39;layers {layers}, embed_p .1, ps [.1,.1,.1]&#39;, f&#39;nb score {nb_score:.4f}&#39;]</span>
<span class="n">message</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">model_msg</span><span class="p">,</span> <span class="n">samples_msg</span><span class="p">,</span> <span class="n">split_msg</span><span class="p">,</span> <span class="n">features_msg</span><span class="p">,</span> <span class="n">score_msg</span><span class="p">])</span>
<span class="n">message</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">do_test</span> <span class="ow">and</span> <span class="n">do_submit</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Submitting...&#39;</span><span class="p">)</span>
    <span class="o">!</span>kaggle competitions submit -c ashrae-energy-prediction -f <span class="s1">&#39;{data_path}/my_submission.csv&#39;</span> -m <span class="s1">&#39;{message}&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

