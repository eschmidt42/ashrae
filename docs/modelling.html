---

title: Modelling & submitting


keywords: fastai
sidebar: home_sidebar

summary: "Playing with different models and submitting predictions over the test set to kaggle. "
description: "Playing with different models and submitting predictions over the test set to kaggle. "
nb_path: "nbs/03_modelling.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03_modelling.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Current implementation of this notebook leads to (private leaderboard score):</p>
<ul>
<li>RandomForest 1.65, </li>
<li>tabular_learner 1.55 and </li>
<li>lgbm 1.67. </li>
</ul>
<p>Those scores relate to a validation set error (<code>nb score</code>) of .8 - 1.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;plotly&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">do_test</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">do_submit</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;../data&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="evaluate_torch" class="doc_header"><code>evaluate_torch</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/modelling.py#L27" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>evaluate_torch</code>(<strong><code>y_true</code></strong>:<code>Tensor</code>, <strong><code>y_pred</code></strong>:<code>Tensor</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loading">Loading<a class="anchor-link" href="#Loading"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">var_names</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">load_var_names</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;var_names.pckl&#39;</span><span class="p">)</span>
<span class="n">var_names</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">load_df</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;X.parquet&#39;</span><span class="p">)</span> <span class="c1">#.sample(100000)</span>

<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">load_df</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;X_test.parquet&#39;</span><span class="p">)</span> <span class="c1">#.sample(100000)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Sampling-df">Sampling <code>df</code><a class="anchor-link" href="#Sampling-df"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># per building_id and meter sampling</span>
    <span class="n">n_sample_per_bid</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;building_id&#39;</span><span class="p">,</span> <span class="s1">&#39;meter&#39;</span><span class="p">])</span>
         <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_sample_per_bid</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">))</span>

<span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># general sampling</span>
    <span class="n">frac_samples</span> <span class="o">=</span> <span class="o">.</span><span class="mi">05</span>
    <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="n">frac_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="n">replace</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s1"> samples = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> %&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Split">Split<a class="anchor-link" href="#Split"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">t_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;t_train.parquet&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1">#split_kind = &#39;random&#39;</span>
<span class="c1">#split_kind = &#39;time&#39;</span>
<span class="c1"># split_kind = &#39;fix_time&#39;</span>
<span class="n">split_kind</span> <span class="o">=</span> <span class="s1">&#39;time_split_day&#39;</span>

<span class="n">t_train</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">train_frac</span> <span class="o">=</span> <span class="o">.</span><span class="mi">8</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">split_dataset</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">split_kind</span><span class="o">=</span><span class="n">split_kind</span><span class="p">,</span> <span class="n">train_frac</span><span class="o">=</span><span class="n">train_frac</span><span class="p">,</span>
                                     <span class="n">t_train</span><span class="o">=</span><span class="n">t_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sets </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span><span class="si">}</span><span class="s1">, train </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, valid </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">var_names</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">var_names_no_anns</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;dep_var&#39;</span><span class="p">:</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;dep_var&#39;</span><span class="p">],</span>
    <span class="s1">&#39;conts&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;conts&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;meter_reading&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">],</span>
    <span class="s1">&#39;cats&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">[</span><span class="s1">&#39;cats&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;meter_&#39;</span><span class="p">)]</span>
<span class="p">}</span>
<span class="n">var_names_no_anns</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">procs</span> <span class="o">=</span> <span class="p">[]</span> 
<span class="c1"># procs = [Categorify, FillMissing, Normalize]</span>
<span class="n">to</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">get_tabular_object</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> 
                                      <span class="n">var_names_no_anns</span><span class="p">,</span>
<span class="c1">#                                       var_names, </span>
                                      <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
                                      <span class="n">procs</span><span class="o">=</span><span class="n">procs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">train_bs</span> <span class="o">=</span> <span class="mi">256</span><span class="o">*</span><span class="mi">8</span>
<span class="n">val_bs</span> <span class="o">=</span> <span class="mi">256</span><span class="o">*</span><span class="mi">8</span>

<span class="n">dls</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="n">train_bs</span><span class="p">,</span> <span class="n">val_bs</span><span class="o">=</span><span class="n">val_bs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Warning: Takes about 12min with the test set</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">test_bs</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">4</span>

<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">test_dl</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">test_bs</span><span class="p">)</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Modelling-with">Modelling with<a class="anchor-link" href="#Modelling-with"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="sklearn"><code>sklearn</code><a class="anchor-link" href="#sklearn"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># params = {&#39;n_estimators&#39;: 20, &#39;max_features&#39;: &#39;sqrt&#39;}</span>
<span class="c1"># model = ensemble.RandomForestRegressor</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dl</span><span class="o">.</span><span class="n">xs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y_valid_true</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">nb_score</span> <span class="o">=</span> <span class="n">evaluate_torch</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">),</span> 
                          <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sklearn loss </span><span class="si">{</span><span class="n">nb_score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fastai"><code>fastai</code><a class="anchor-link" href="#fastai"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Fastai finding: make sure your test set values are not out of domain $\Rightarrow$ <code>timestampYear</code> in this notebook is put into the training set but there only takes on the value 2016.0, but in the test set it's 2017.0 and 2018.0, causing the predictions to zero out everywhere.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span>
           <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> 
                   <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()]),]</span>
<span class="n">y_range</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Swish" class="doc_header"><code>class</code> <code>Swish</code><a href="https://github.com/fastai/fastai/tree/master/fastai/layers.py#L620" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Swish</code>() :: <code>Module</code></p>
</blockquote>
<p>Same as <code>nn.Module</code>, but no need for subclasses to call <code>super().__init__</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Sine" class="doc_header"><code>class</code> <code>Sine</code><a href="https://github.com/eschmidt42/ashrae/tree/master/ashrae/modelling.py#L43" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Sine</code>(<strong><code>inplace</code></strong>:<code>bool</code>=<em><code>False</code></em>) :: <code>ReLU</code></p>
</blockquote>
<p>Applies the rectified linear unit function element-wise:</p>
<p>:math:<code>\text{ReLU}(x) = (x)^+ = \max(0, x)</code></p>
<p>Args:
    inplace: can optionally do the operation in-place. Default: <code>False</code></p>
<p>Shape:</p>

<pre><code>- Input: :math:`(N, *)` where `*` means, any number of additional
  dimensions
- Output: :math:`(N, *)`, same shape as the input

</code></pre>
<p>.. image:: ../scripts/activation_images/ReLU.png</p>
<p>Examples::</p>

<pre><code>&gt;&gt;&gt; m = nn.ReLU()
&gt;&gt;&gt; input = torch.randn(2)
&gt;&gt;&gt; output = m(input)


</code></pre>
<p>An implementation of CReLU - <a href="https://arxiv.org/abs/1603.05201">https://arxiv.org/abs/1603.05201</a></p>

<pre><code>&gt;&gt;&gt; m = nn.ReLU()
&gt;&gt;&gt; input = torch.randn(2).unsqueeze(0)
&gt;&gt;&gt; output = torch.cat((m(input),m(-input)))</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">125</span><span class="p">]</span>

<span class="c1"># config = None</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">tabular_config</span><span class="p">(</span><span class="n">embed_p</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># config = tabular_config(act_cls=nn.ReLU(inplace=True))</span>
<span class="c1"># config = tabular_config(act_cls=Swish(inplace=True))</span>
<span class="c1"># config = tabular_config(act_cls=Sine(inplace=True))</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
                        <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">evaluate_torch</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot_loss</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">y_valid_pred</span><span class="p">,</span> <span class="n">y_valid_true</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="n">test_dl</span><span class="p">)</span>
    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">(</span><span class="n">y_test_pred</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nb_score</span> <span class="o">=</span> <span class="n">evaluate_torch</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">,</span> 
                          <span class="n">y_valid_pred</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fastai loss </span><span class="si">{</span><span class="n">nb_score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y_valid_pred</span><span class="p">,</span> <span class="n">y_valid_true</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">),</span> <span class="n">cnr</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="lightgbm"><code>lightgbm</code><a class="anchor-link" href="#lightgbm"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">lgb_train</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">to</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<span class="n">lgb_eval</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> 
                       <span class="n">reference</span><span class="o">=</span><span class="n">lgb_train</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;boosting_type&#39;</span><span class="p">:</span> <span class="s1">&#39;gbdt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;regression&#39;</span><span class="p">,</span>
    <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="s1">&#39;bagging_fraction&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s1">&#39;bagging_freq&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">gbm</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lgb_train</span><span class="p">,</span>
                <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">valid_sets</span><span class="o">=</span><span class="n">lgb_eval</span><span class="p">,</span>
                <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">gbm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                           <span class="n">num_iteration</span><span class="o">=</span><span class="n">gbm</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">gbm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dl</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                              <span class="n">num_iteration</span><span class="o">=</span><span class="n">gbm</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">y_valid_true</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">ys</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">nb_score</span> <span class="o">=</span> <span class="n">evaluate_torch</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">),</span> 
                          <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sklearn loss </span><span class="si">{</span><span class="n">nb_score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inspecting">Inspecting<a class="anchor-link" href="#Inspecting"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="dep_var-distribution"><code>dep_var</code> distribution<a class="anchor-link" href="#dep_var-distribution"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Train vs validation distributions</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preprocessing</span><span class="o">.</span><span class="n">hist_plot_preds</span><span class="p">(</span><span class="n">pick_random</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">),</span> 
                              <span class="n">pick_random</span><span class="p">(</span><span class="n">y_valid_pred</span><span class="p">),</span> 
                              <span class="n">label0</span><span class="o">=</span><span class="s1">&#39;truth&#39;</span><span class="p">,</span> <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;prediction&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">preprocessing</span><span class="o">.</span><span class="n">hist_plot_preds</span><span class="p">(</span><span class="n">pick_random</span><span class="p">(</span><span class="n">y_valid_true</span><span class="p">),</span> 
                                  <span class="n">pick_random</span><span class="p">(</span><span class="n">y_test_pred</span><span class="p">),</span> 
                                  <span class="n">label0</span><span class="o">=</span><span class="s1">&#39;truth (validation)&#39;</span><span class="p">,</span> 
                                  <span class="n">label1</span><span class="o">=</span><span class="s1">&#39;prediction (test set)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Boldly-wrong-predictions">Boldly wrong predictions<a class="anchor-link" href="#Boldly-wrong-predictions"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">miss_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;building_id&#39;</span><span class="p">,</span> <span class="s1">&#39;meter&#39;</span><span class="p">,</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">miss_cols</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">miss_cols</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">to</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span>
<span class="n">bwt</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">BoldlyWrongTimeseries</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">y_valid_true</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bwt</span><span class="o">.</span><span class="n">run_boldly</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finding:</p>
<ul>
<li>lgbm makes predictions of negative values!</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Submission-to-kaggle">Submission to kaggle<a class="anchor-link" href="#Submission-to-kaggle"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_test</span><span class="p">:</span>
    <span class="n">y_test_pred_original</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tensor</span><span class="p">(</span><span class="n">y_test_pred</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">y_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cnr</span><span class="p">(</span><span class="n">y_test_pred_original</span><span class="p">),</span>
                         <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;meter_reading&#39;</span><span class="p">],</span>
                         <span class="n">index</span><span class="o">=</span><span class="n">df_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">y_out</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">41697600</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">if</span> <span class="n">do_submit</span><span class="p">:</span>
    <span class="n">y_out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">data_path</span><span class="o">/</span><span class="s1">&#39;my_submission.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>kaggle competitions submit -c ashrae-energy-prediction -f submission.csv -m "Message"</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;baseline (linear regression)&#39;</span>
<span class="n">split_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;split kind &quot;</span><span class="si">{</span><span class="n">split_kind</span><span class="si">}</span><span class="s1">&quot; train_frac </span><span class="si">{</span><span class="n">train_frac</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">samples_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;num samples </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> %&#39;</span>
<span class="n">features_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;dep_var_stats and 1hot meter&#39;</span>
<span class="n">score_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;nb score </span><span class="si">{</span><span class="n">nb_score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="c1"># message = [&#39;baseline (linear regression on dep_var_stats and 1hot meter) &#39;, &#39;500 obs/bid&#39;, f&#39;nb score {nb_score:.4f}&#39;]</span>
<span class="c1"># message = [&#39;random forest&#39;, &#39;500 obs/bid&#39;, &#39;all features&#39;, f&#39;nb score {nb_score:.4f}&#39;]</span>
<span class="c1"># message = [&#39;lightgbm&#39;, &#39;500 obs/bid&#39;, &#39;100 rounds&#39;, &#39;42 leaves&#39;, &#39;lr .5&#39;, f&#39;nb score {nb_score:.4f}&#39;]</span>
<span class="c1"># message = [&#39;tabular_learner&#39;, &#39;500 obs/bid&#39;, &#39;all features&#39;, f&#39;layers {layers}, embed_p .1, ps [.1,.1,.1]&#39;, f&#39;nb score {nb_score:.4f}&#39;]</span>
<span class="n">message</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">model_msg</span><span class="p">,</span> <span class="n">samples_msg</span><span class="p">,</span> <span class="n">split_msg</span><span class="p">,</span> <span class="n">features_msg</span><span class="p">,</span> <span class="n">score_msg</span><span class="p">])</span>
<span class="n">message</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">do_test</span> <span class="ow">and</span> <span class="n">do_submit</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Submitting...&#39;</span><span class="p">)</span>
    <span class="o">!</span>kaggle competitions submit -c ashrae-energy-prediction -f <span class="s1">&#39;{data_path}/my_submission.csv&#39;</span> -m <span class="s1">&#39;{message}&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>submission scores</strong></p>
<p>random forest:</p>
<ul>
<li>5 obs per building ID, .75 max_features, 100 estimators: <ul>
<li>nb score = 2.37</li>
<li>kaggle score = 1.68 / 1.86</li>
</ul>
</li>
</ul>
<p>tabular learner:</p>
<ul>
<li>5 obs per building ID, layers=[500,250], lr = 2e-3: <ul>
<li>nb score = 1.55</li>
<li>kaggle score = 1.8 / 2.13</li>
</ul>
</li>
<li>5 obs per building ID, layers=[500,250], second run with lr = 1e-3: <ul>
<li>nb score = 1.57</li>
<li>kaggle score = 1.846 / 2.13</li>
</ul>
</li>
<li>50 obs per building ID, layers=[500,250], 2 rounds: <ul>
<li>nb score = 1.39</li>
<li>kaggle score = 1.722 / 2.51</li>
</ul>
</li>
<li>50 obs per building ID, layers=[500,250], 2 rounds: <ul>
<li>nb score = 1.34</li>
<li>kaggle score = 1.641 / 2.266</li>
</ul>
</li>
<li>50 obs per building ID, layers=[500,250], 2 rounds, bs=256: <ul>
<li>nb score = 1.32</li>
<li>kaggle score = 1.643 / 1.926</li>
</ul>
</li>
<li>500 obs per building ID, layers=[500,250], 3 rounds: <ul>
<li>nb score = 1.19</li>
<li>kaggle score = 1.62 / 2.55</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finding:</p>
<ul>
<li>nb scores are lower than the kaggle scores</li>
<li>random forest seems to have public and private score closer to each other than tabular learner</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>randomly splitting</strong></p>
<p>Finding (modified target values, all info = info except time):</p>
<ul>
<li>Linear:<ul>
<li>meter only @100k: 2.1</li>
<li>all info minus time @100k: 2.3</li>
<li>all info incl time @100k: 2.32</li>
<li>all info incl time + ids @100k: 2.32</li>
</ul>
</li>
<li>RandomForest:<ul>
<li>meter only @100k: 2.2</li>
<li>all info minus time @100k: 2.7</li>
<li>all info incl time @100k: 2.74</li>
<li>all info incl time + ids @100k: 2.82</li>
</ul>
</li>
<li>tabular_learner:<ul>
<li>meter only @100k: 2.1</li>
<li>all info minus time @100k: 1.56</li>
<li>all info incl time @100k: 1.52</li>
<li>all info incl time + ids @100k: 0.96</li>
</ul>
</li>
</ul>
<p><strong>splitting along time</strong>
Finding:</p>
<ul>
<li>Linear:<ul>
<li>meter only @100k: 2.1</li>
<li>all info minus time @100K: 2.2</li>
<li>all info incl time @100k: 2.3</li>
<li>all info incl time + ids @100k: 2.29</li>
</ul>
</li>
<li>RandomForest:<ul>
<li>meter only @100k: 2.1</li>
<li>all info minus time @100K: 2.7</li>
<li>all info incl time @100k: 2.52</li>
<li>all info incl time + ids @100k: 2.62</li>
</ul>
</li>
<li>tabular_learner:<ul>
<li>meter only @100k: 2.06</li>
<li>all info minus time @100K: 1.62</li>
<li>all info incl time @100k: 1.62</li>
<li>all info incl time + ids @100k: 1.31</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
</div>
 

